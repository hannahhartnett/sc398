---
title: "United States Protest Events in 2020"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: scroll
runtime: shiny
---

```{r}
library(flexdashboard)
library(shiny)
library(readr)
library(dplyr)
library(ggplot2)
library(leaflet)
library(plotly)
library(shinythemes)

shinythemes::themeSelector()

acled <- read_csv('acled.csv')
```


Event Type and Location
================================

Column {data-width=650, style="height:200pc;"}
-----------------------------------------------------------------------


In the year of the 'new normal,' we have experienced many momentous and novel events: a global pandemic; increased awareness of national racial injustices, specifically on the part of the police force, as a result of the murders of countless Black Americans; and a contentious presidential election. This interactive app is intended as an accompaniment to year-end news summaries, to aid investigation of protest events as a response to these significant new phenomena. How have Americans gathered to react to national events in 2020? The app was created using data from the Armed Conflict Location and Event Data Project: https://github.com/hannahhartnett/sc398/blob/main/US-ACLED.csv. 


### Chart A

```{r}
shinyApp(
  
  ui = fluidPage(theme = shinytheme("cerulean"),
    inputPanel(
      sliderInput("slider", "Dates:",
                  min = as.Date("2020-01-01","%Y-%m-%d"), 
                  max = as.Date("2020-12-31","%Y-%m-%d"), 
                  value = c(as.Date("2020-04-01"), as.Date("2020-04-30")),
                  timeFormat = "%Y-%m-%d")
      
    ),
    
    leafletOutput("event_map")
  ),
  
  server = function(input, output) {
    output$event_map <- renderLeaflet({
      leaflet(acled %>% filter(event_date <= input$slider[2] & event_date >= input$slider[1])) %>%
  addTiles() %>%
  addCircles(lng = ~longitude, lat = ~latitude, label = ~lapply(lab, htmltools::HTML), popup = ~notes)
      
      
    })
  },
  
  options = list(height = 550)
)
```

Column {data-width=350}
-----------------------------------------------------------------------

### Chart B

```{r}

# drill down sub event type

ui <- shinyUI(
  fluidPage(theme = shinytheme("cerulean"),
    titlePanel("Event Sub-Types"),
    sidebarLayout(
      sidebarPanel(
        uiOutput("eventInput")
      ),
      mainPanel(
        plotOutput("sub_eventPlot")
      )
    )
  ))

server <- shinyServer(function(input, output) {

  output$eventInput <- renderUI({
    selectInput(
      inputId = "event",
      label = "Select an Event Type:",
      choices = levels(as.factor(acled$event_type))
    )
  })

  output$sub_eventPlot <- renderPlot({
    ggplot(acled %>% filter(event_type == input$event), aes(x = sub_event_type)) + geom_bar() +
      labs(x = 'Sub Event Type',
           y = 'Count', 
           title = 'Count of Sub-Event Type')
  })
})

shinyApp(ui = ui, server = server)
```

Here we can see a wide variety of different protest events in the US in 2020; the vast majority were peaceful protests, but we also see a large number of protests with intervention and violent demonstrations.


### Chart C

```{r}
library(lubridate)

acled_time <- acled %>% group_by(admin1, event_date) %>% summarize(count = n())


# view by state


library(shiny)

ui <- shinyUI(
  fluidPage(theme = shinytheme("cerulean"),
    titlePanel("State"),
    sidebarLayout(
      sidebarPanel(
        uiOutput("stateInput")
      ),
      mainPanel(
        plotOutput("statePlot")
      )
    )
  ))

server <- shinyServer(function(input, output) {

  output$stateInput <- renderUI({
    selectInput(
      inputId = "state",
      label = "Select a State:",
      choices = levels(as.factor(acled_time$admin1))
    )
  })

  output$statePlot <- renderPlot({
    ggplot(acled_time %>% filter(admin1 == input$state), aes(x = event_date, y = count)) + geom_line() +
      labs(x = 'Event Date',
           y = 'Count', 
           title = 'Total Number of Protest Events per Day, by State')
  })
})

shinyApp(ui = ui, server = server)
```


#### Key Trends
- The number of protests per day peaks earlier in Minnesota and Georgia, the location of the murders of George Floyd and Ahmaud Arbery, respectively, than most other states. 
- The overall number of protests in Washington D.C. is fewer than in most other states, but it is greatest in the fall, at the peak of the election season for the 2020 Presidential Election.



Fatalities
================================


Column {data-width=650, style="height:1000pc;"}
-----------------------------------------------------------------------

### Chart A

```{r}
tab1 <- select(acled, groups, fatality)

death_table <- tab1 %>% 
  group_by(groups) %>%
  count(fatality)

plotType <- function(input) {
  switch(input,
         Count = "stack",
         Proportional = "fill")
}

ui <- shinyUI(
  fluidPage(theme = shinytheme("cerulean"),
    titlePanel("Group"),
    sidebarLayout(
      sidebarPanel(
        sliderInput("min_n", label = "Minimum Number of Incidents by Group",
                  min = 0, max = 20, value = 20, step = 2),
        radioButtons("pType", "Choose plot type:",
                 list("Count", "Proportional"))
      ),
      mainPanel(
        plotOutput("incident_plot")
      )
    )
  ))
  
  
server <- shinyServer(function(input, output) {
  output$incident_plot <- renderPlot({
    ggplot(death_table %>% filter(n>input$min_n), aes(x=fatality, y=n, fill=groups))+
      geom_bar(position = plotType(input$pType), stat = "identity")+
      labs(x = "Fatality?", y = "Number of Incidents", fill = "Groups Involved")
  })
})

shinyApp(ui, server)
```

#### Key Trends
- Incidents with no fatalities vastly outnumber incidents with fatalities, as can be seen by the count figure.
- The vast majority of non-fatality incidents involve only protests, while the vast majority of incidents with a fatality involved Police officers.

Column {data-width=400, style="height:35pc;"}
-----------------------------------------------------------------------

### Chart B


```{r}
library(zoo)

shinyApp(
  
  ui = fluidPage(theme = shinytheme("cerulean"),
    plotlyOutput("page2chartB")
  ),
  
  
  
  server = function(input, output) {
    
    output$page2chartB <- renderPlotly({


deaths_month <- acled %>%
  filter(fatalities>0) %>% 
  # use 'as.yearmon' to create a variable identifying the unique year-month
  # combination in which each observation falls
  mutate(yearmon = as.yearmon(event_date)) %>%
  # use that variable to group the data
  group_by(yearmon) %>% 
  # count the number of observations in each of those year-month bins. if you
  # want to summarise the data some other way, use 'summarise' here instead.
  count() %>% 
  # plot the resulting series with yearmon on the x-axis and using 'geom_col'
  # instead of 'geom_hist' to preserve the temporal ordering and avoid
  # having to specify stat = "identity"
  ggplot(aes(x = yearmon, y = n)) + geom_col() +
  labs(x = "Month", y = "Number of Deaths", title = "Number of Total Deaths by Month") + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1, vjust = 0.5))
ggplotly(deaths_month, tooltip = c("n"))
    })
  }
)
```

#### Key Trends
- Incidents involving a fatality peaked in the summer of 2020 with June being the month with the most fatalities.
- Incidents involving a fatality make up a small proportion of total incidents by month.

Black Lives Matter Protests
================================


Column {data-width=650, style="height:200pc;"}
-----------------------------------------------------------------------

### Chart A

```{r}
shinyApp(
  
  ui = fluidPage(theme = shinytheme("cerulean"),
    inputPanel(
      radioButtons("time", label = "Time Frame:",
                   choices = c("Before George Floyd's Death" = "Before George Floyd's Death",
                               "Week After George Floyd's Death" = "Week After George Floyd's Death",
                               "June" = "June",
                               "July" = "July",
                               "August" = "August",
                               "September" = "September",
                               "October" = "October",
                               "November" = "November",
                               "December" = "December"))
      
    ),
    
    leafletOutput("event_map")
  ),
  
  
  
  server = function(input, output) {
    
    output$event_map <- renderLeaflet({

if (input$time == "Before George Floyd's Death") {
  min_date = "2020-01-01"
  max_date = "2020-05-24"
} else if (input$time == "Week After George Floyd's Death") {
  min_date = "2020-05-25"
  max_date = "2020-05-31"
} else if (input$time == "June") {
  min_date = "2020-06-01"
  max_date = "2020-06-30"
} else if (input$time == "July") {
  min_date = "2020-07-01"
  max_date = "2020-07-31"
} else if (input$time == "August") {
  min_date = "2020-08-01"
  max_date = "2020-08-31"
} else if (input$time == "September") {
  min_date = "2020-09-01"
  max_date = "2020-09-30"
} else if (input$time == "October") {
  min_date = "2020-10-01"
  max_date = "2020-10-31"
} else if (input$time == "November") {
  min_date = "2020-11-01"
  max_date = "2020-11-30"
} else if (input$time == "December") {
  min_date = "2020-12-01"
  max_date = "2020-12-31"
}
      
      leaflet(acled %>% filter(grepl("BLM", assoc_actor_1)) %>% filter(event_date <= max_date & event_date >= min_date)) %>%
  addTiles() %>%
  addCircles(lng = ~longitude, lat = ~latitude, label = ~lapply(lab, htmltools::HTML), popup = ~notes)
      
      
    })
  },
  
  options = list(height = 850)
)
```


Event Actors
================================


Column {data-width=650, style="height:1000pc;"}
-----------------------------------------------------------------------

### Chart A
```{r}

actorList <- unique(acled$assoc_actor_label1)

ui <- shinyUI(
  fluidPage(
    titlePanel("Actor Groups"),
    sidebarLayout(
      sidebarPanel(
         checkboxGroupInput("actor", "Choose Actors", choices = actorList, selected = c("AltRight", "Democrats", "Leftist", "Progressive", "Republicans"))
      ),
      mainPanel(
        plotOutput("actorPlot")
      )
    )
  ))

server <- shinyServer(function(input, output) {

  # output$actorInput <- renderUI({
  #   selectInput(
  #     inputId = "actor",
  #     label = "Select an Actor:",
  #     choices = levels(as.factor(acled$assoc_actor_label1))
  #   )
  # })

  output$actorPlot <- renderPlot({
    ggplot(acled %>% filter(assoc_actor_label1 == c(input$actor)), aes(x = assoc_actor_label1, fill = assoc_actor_label1)) + geom_bar() +
      labs(x = 'Actor Groups',
           y = 'Count', 
           fill = 'Actor Groups',
           title = 'Total Number of Events Participated in by Actor Groups')
  })
})

shinyApp(ui = ui, server = server)

```
#### Key Trends
  - Black Lives Matter and other groups protesting for the end of racist institutions, policies, etc. were by far the most active group in 2020
  - Many other groups were also active and it would be interesting for a study to be done on a historical basis comparing their activity over time
  
#### Information About Data
  Actor groups are categorized by affliation. So, BLM protestors, African American designated groups, the ACLU, and NAACP are all incorporated under the tag "BLM-Related". Migrant Rights includes ABOLISH ICE protestors, DREAMers, Refugees, La Resistancia, and other migrant identified groups. Similarly, politically affiliated groups included Republican identified groups and Democrat identified groups. We also categorized a few other politically based groups such as Progressive organizations like the MoveOn movement, the Indivisible Movement, the Sunrise Movement and Democratic Socialists for America as well as more leftist operating groups such as Communists, Socialists, ANTIFA and other anti-fascist identified groups. Similarly, groups such as the Boogaloo Boys, Proud Boys, Tea Party, White Nationalists, QAnon, and Patriot Party groups were all lumped together under the tag AltRight. The remaining tags were all generated by the keywords implied in their names, with those that remained grouped together as "Other".
