---
title: "United States Protest Events in 2020"
output: 
  flexdashboard::flex_dashboard:
    orientation: columns
    vertical_layout: scroll
runtime: shiny
---

```{r setup, include=FALSE}
library(flexdashboard)
library(shiny)
library(readr)
library(dplyr)
library(ggplot2)
library(leaflet)
library(plotly)

acled <- read_csv('./US-ACLED.csv')
head(acled)

# keep only 2020 events
acled <- acled %>% filter(year == 2020)

# format date
acled$event_date <- as.Date(acled$event_date, '%d-%b-%y')
acled$lab <- paste(sep = "<br/>",
                   acled$event_date, acled$event_type, acled$location, acled$admin1)

# categorical label for actor1 and actor 2
acled$actor_label1 <- NA
acled$actor_label2 <- NA
for(i in 1:nrow(acled)) {
  if(grepl( "Protesters", acled$actor1[i]))
    acled$actor_label1[i] <- "Protesters"
  else if(grepl( "Police", acled$actor1[i]))
    acled$actor_label1[i] <- "Police"
  else if(grepl( "Sole Perp", acled$actor1[i]))
    acled$actor_label1[i] <- "Sole Perpetrator"
  else if(grepl( "Riot", acled$actor1[i]))
    acled$actor_label1[i] <- "Rioters"
  else if(is.na(acled$actor1[i]))
    acled$actor_label2[i] <- "None"
  else
    acled$actor_label1[i] <- "Other"
}

for(i in 1:nrow(acled)) {
  if(grepl( "Protesters", acled$actor2[i]))
    acled$actor_label2[i] <- "Protesters"
  else if(grepl( "Police", acled$actor2[i]))
    acled$actor_label2[i] <- "Police"
  else if(grepl( "Sole Perp", acled$actor2[i]))
    acled$actor_label2[i] <- "Sole Perpetrator"
  else if(grepl( "Riot", acled$actor2[i]))
    acled$actor_label2[i] <- "Rioters"
  else if(is.na(acled$actor2[i]))
    acled$actor_label2[i] <- "None"
  else
    acled$actor_label2[i] <- "Other"
}

# interacting groups variable (need to remove NAs)
acled$groups <- paste(acled$actor_label1, "and", acled$actor_label2)

# break fatality into two groups
acled$fatality <- ifelse(acled$fatalities>0, "Yes", "No")

# group interaction variable
acled$groups <- paste(acled$actor_label1, "and", acled$actor_label2)

# cleaning the group interaction variable
acled$groups[acled$groups == "Other and NA"] <- "Other"
acled$groups[acled$groups == "Other and Other"] <- "Other"
acled$groups[acled$groups == "Rioters and NA"] <- "Rioters"
acled$groups[acled$groups == "Protesters and NA"] <- "Protesters"
acled$groups[acled$groups == "Sole Perpetrator and NA"] <- "Sole Perpetrator"
acled$groups[acled$groups == "Police and NA"] <- "Police"
acled$groups[acled$groups == "Protesters and Protesters"] <- "Protesters"
acled$groups[acled$groups == "Police and Rioters"] <- "Rioters and Police"
acled$groups[acled$groups == "Sole Perpetrator and Protesters"] <- "Protesters and Sole Perpetrator"
acled$groups[acled$groups == "Other and Sole Perpetrator"] <- "Sole Perpetrator and Other"
acled$groups[acled$groups == "Other and Police"] <- "Police and Other"
acled$groups[acled$groups == "Sole Perpetrator and Police"] <- "Police and Sole Perpetrator"
acled$groups[acled$groups == "Rioters and Rioters"] <- "Rioters"
```

Page 1
================================

Column {data-width=650, style="height:200pc;"}
-----------------------------------------------------------------------

### Chart A

```{r}
shinyApp(
  
  ui = fluidPage(
    inputPanel(
      sliderInput("slider", "Dates:",
                  min = as.Date("2020-01-01","%Y-%m-%d"), 
                  max = as.Date("2020-12-31","%Y-%m-%d"), 
                  value = c(as.Date("2020-04-01"), as.Date("2020-04-30")),
                  timeFormat = "%Y-%m-%d")
      
    ),
    
    leafletOutput("event_map")
  ),
  
  server = function(input, output) {
    output$event_map <- renderLeaflet({
      leaflet(acled %>% filter(event_date <= input$slider[2] & event_date >= input$slider[1])) %>%
  addTiles() %>%
  addCircles(lng = ~longitude, lat = ~latitude, label = ~lapply(lab, htmltools::HTML), popup = ~notes)
      
      
    })
  },
  
  options = list(height = 550)
)
```

Column {data-width=350}
-----------------------------------------------------------------------

### Chart B

```{r}

# drill down sub event type

ui <- shinyUI(
  fluidPage(
    titlePanel("Event Sub-Types"),
    sidebarLayout(
      sidebarPanel(
        uiOutput("eventInput")
      ),
      mainPanel(
        plotOutput("sub_eventPlot")
      )
    )
  ))

server <- shinyServer(function(input, output) {

  output$eventInput <- renderUI({
    selectInput(
      inputId = "event",
      label = "Select an Event Type:",
      choices = levels(as.factor(acled$event_type))
    )
  })

  output$sub_eventPlot <- renderPlot({
    ggplot(acled %>% filter(event_type == input$event), aes(x = sub_event_type)) + geom_bar() +
      labs(x = 'Sub Event Type',
           y = 'Count', 
           title = 'Count of Sub-Event Type')
  })
})

shinyApp(ui = ui, server = server)
```



### Chart C

```{r}
library(lubridate)

acled_time <- acled %>% group_by(admin1, event_date) %>% summarize(count = n())


# view by state


library(shiny)

ui <- shinyUI(
  fluidPage(
    titlePanel("State"),
    sidebarLayout(
      sidebarPanel(
        uiOutput("stateInput")
      ),
      mainPanel(
        plotOutput("statePlot")
      )
    )
  ))

server <- shinyServer(function(input, output) {

  output$stateInput <- renderUI({
    selectInput(
      inputId = "state",
      label = "Select a State:",
      choices = levels(as.factor(acled_time$admin1))
    )
  })

  output$statePlot <- renderPlot({
    ggplot(acled_time %>% filter(admin1 == input$state), aes(x = event_date, y = count)) + geom_line() +
      labs(x = 'Event Date',
           y = 'Count', 
           title = 'Total Number of Protest Events per Day, by State')
  })
})

shinyApp(ui = ui, server = server)
```


#### Key Trends
- The number of protests per day peaks earlier in Minnesota and Georgia, the location of the murders of George Floyd and Ahmaud Arbery, respectively, than most other states. 
- The overall number of protests in Washington D.C. is fewer than in most other states, but it is greatest in the fall, at the peak of the election season for the 2020 Presidential Election.



Page 2
================================


Column {data-width=650, style="height:200pc;"}
-----------------------------------------------------------------------

### Chart A

```{r}
tab1 <- select(acled, groups, fatality)

death_table <- tab1 %>% 
  group_by(groups) %>%
  count(fatality)

plotType <- function(input) {
  switch(input,
         Count = "stack",
         Proportional = "fill")
}

ui <- shinyUI(
  fluidPage(
    titlePanel("Group"),
    sidebarLayout(
      sidebarPanel(
        sliderInput("min_n", label = "Minimum Number of Incidents by Group",
                  min = 0, max = 20, value = 20, step = 2),
        radioButtons("pType", "Choose plot type:",
                 list("Count", "Proportional"))
      ),
      mainPanel(
        plotOutput("incident_plot")
      )
    )
  ))
  
  
server <- shinyServer(function(input, output) {
  output$incident_plot <- renderPlot({
    ggplot(death_table %>% filter(n>input$min_n), aes(x=fatality, y=n, fill=groups))+
      geom_bar(position = plotType(input$pType), stat = "identity")
  })
})

shinyApp(ui, server)
```

Column {data-width=350}
-----------------------------------------------------------------------

### Chart B


```{r}
library(zoo)

deaths_month <- acled %>%
  filter(fatalities>0) %>% 
  # use 'as.yearmon' to create a variable identifying the unique year-month
  # combination in which each observation falls
  mutate(yearmon = as.yearmon(event_date)) %>%
  # use that variable to group the data
  group_by(yearmon) %>% 
  # count the number of observations in each of those year-month bins. if you
  # want to summarise the data some other way, use 'summarise' here instead.
  count() %>% 
  # plot the resulting series with yearmon on the x-axis and using 'geom_col'
  # instead of 'geom_hist' to preserve the temporal ordering and avoid
  # having to specify stat = "identity"
  ggplot(aes(x = yearmon, y = n)) + geom_col()
ggplotly(deaths_month)
```


Page 3
================================


Column {data-width=650, style="height:200pc;"}
-----------------------------------------------------------------------

### Chart A

```{r}
shinyApp(
  
  ui = fluidPage(
    inputPanel(
      radioButtons("time", label = "Time Frame:",
                   choices = c("Before George Floyd's Death" = "Before George Floyd's Death",
                               "Week After George Floyd's Death" = "Week After George Floyd's Death",
                               "June" = "June",
                               "July" = "July",
                               "August" = "August",
                               "September" = "September",
                               "October" = "October",
                               "November" = "November",
                               "December" = "December"))
      
    ),
    
    leafletOutput("event_map")
  ),
  
  
  
  server = function(input, output) {
    
    output$event_map <- renderLeaflet({

if (input$time == "Before George Floyd's Death") {
  min_date = "2020-01-01"
  max_date = "2020-05-24"
} else if (input$time == "Week After George Floyd's Death") {
  min_date = "2020-05-25"
  max_date = "2020-05-31"
} else if (input$time == "June") {
  min_date = "2020-06-01"
  max_date = "2020-06-30"
} else if (input$time == "July") {
  min_date = "2020-07-01"
  max_date = "2020-07-31"
} else if (input$time == "August") {
  min_date = "2020-08-01"
  max_date = "2020-08-31"
} else if (input$time == "September") {
  min_date = "2020-09-01"
  max_date = "2020-09-30"
} else if (input$time == "October") {
  min_date = "2020-10-01"
  max_date = "2020-10-31"
} else if (input$time == "November") {
  min_date = "2020-11-01"
  max_date = "2020-11-30"
} else if (input$time == "December") {
  min_date = "2020-12-01"
  max_date = "2020-12-31"
}
      
      leaflet(acled %>% filter(grepl("BLM", assoc_actor_1)) %>% filter(event_date <= max_date & event_date >= min_date)) %>%
  addTiles() %>%
  addCircles(lng = ~longitude, lat = ~latitude, label = ~lapply(lab, htmltools::HTML), popup = ~notes)
      
      
    })
  },
  
  options = list(height = 850)
)
```
